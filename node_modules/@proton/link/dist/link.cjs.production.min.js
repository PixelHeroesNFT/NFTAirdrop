"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@proton/signing-request"),r=require("@proton/js"),n=e(require("isomorphic-ws")),i=e(require("pako")),o=require("uuid"),a=require("eosjs-ecc");function s(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,i)}function c(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function a(e){s(o,n,i,a,c,"next",e)}function c(e){s(o,n,i,a,c,"throw",e)}a(void 0)}))}}function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function f(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,r){return(d=p()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&l(i,r.prototype),i}).apply(null,arguments)}function y(e){var t="function"==typeof Map?new Map:void 0;return(y=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return d(e,arguments,h(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),l(r,e)})(e)}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function m(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return v(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?v(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function g(e,t){return e(t={exports:{}},t.exports),t.exports}var b=g((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var i=Object.create((t&&t.prototype instanceof h?t:h).prototype),o=new _(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return{value:void 0,done:!0}}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=w(a,r);if(s){if(s===f)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===f)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,o),i}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var f={};function h(){}function l(){}function p(){}var d={};d[i]=function(){return this};var y=Object.getPrototypeOf,v=y&&y(y(S([])));v&&v!==t&&r.call(v,i)&&(d=v);var m=p.prototype=h.prototype=Object.create(d);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var n;this._invoke=function(i,o){function a(){return new t((function(n,a){!function n(i,o,a,s){var c=u(e[i],e,o);if("throw"!==c.type){var f=c.arg,h=f.value;return h&&"object"==typeof h&&r.call(h,"__await")?t.resolve(h.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(h).then((function(e){f.value=e,a(f)}),(function(e){return n("throw",e,a,s)}))}s(c.arg)}(i,o,n,a)}))}return n=n?n.then(a,a):a()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return f;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,f;var i=n.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,f):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,f)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function S(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:P}}function P(){return{value:void 0,done:!0}}return l.prototype=m.constructor=p,p.constructor=l,l.displayName=s(p,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===l||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,s(e,a,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},g(b.prototype),b.prototype[o]=function(){return this},e.AsyncIterator=b,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var a=new b(c(t,r,n,i),o);return e.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},g(m),s(m,a,"Generator"),m[i]=function(){return this},m.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=S,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return a.type="throw",a.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;k(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),f}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}})),w=function(e){function t(t){var r;return(r=e.call(this,"User canceled request "+(t?"("+t+")":""))||this).code="E_CANCEL",r}return f(t,e),t}(y(Error)),x=function(e){function t(t){var r;return(r=e.call(this,"Unable to verify identity "+(t?"("+t+")":""))||this).code="E_IDENTITY",r}return f(t,e),t}(y(Error)),k=function(e){function t(t,r){var n;return(n=e.call(this,t)||this).code=r,n}return f(t,e),t}(y(Error)),_={version:"eosio::abi/1.1",types:[],structs:[{name:"sealed_message",base:"",fields:[{name:"from",type:"public_key"},{name:"nonce",type:"uint64"},{name:"ciphertext",type:"bytes"},{name:"checksum",type:"uint32"}]},{name:"link_create",base:"",fields:[{name:"session_name",type:"name"},{name:"request_key",type:"public_key"}]},{name:"link_info",base:"",fields:[{name:"expiration",type:"time_point_sec"}]}],actions:[],ricardian_clauses:[],error_messages:[],tables:[],abi_extensions:[]},S=r.Serialize.getTypesFromAbi(r.Serialize.createInitialTypes(),_);function P(e,t){var n=S.get(t);if(!n)throw new Error("No such type: "+t);var i=new r.Serialize.SerialBuffer;return n.serialize(i,e),i.asUint8Array()}function E(e){return e.startsWith("PUB_")?e:r.Numeric.publicKeyToString(r.Numeric.stringToPublicKey("EOS"+e.substr(-50)))}function O(){return q.apply(this,arguments)}function q(){return(q=c(b.mark((function e(){var t;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("undefined"==typeof window||!window.crypto){e.next=6;break}return t=new Uint32Array(32),window.crypto.getRandomValues(t),e.abrupt("return",a.PrivateKey.fromBuffer(Buffer.from(t)).toString());case 6:return e.next=8,a.randomKey();case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var L=function(){function e(){}return e.prototype.remove=function(){var e=c(b.mark((function e(){return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.link.storage){e.next=3;break}return e.next=3,this.link.removeSession(this.identifier,this.auth);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e.restore=function(e,t){switch(t.type){case"channel":return new T(e,t.data,t.metadata);case"fallback":return new j(e,t.data,t.metadata);default:throw new Error("Unable to restore, session data invalid")}},e}(),T=function(e){function t(t,r,n){var i;return(i=e.call(this)||this).type="channel",i.timeout=12e4,i.link=t,i.auth=r.auth,i.publicKey=r.publicKey,i.channel=r.channel,i.identifier=r.identifier,i.encrypt=function(e){return t=e.encode(!0,!1),i=a.Aes.encrypt(n=r.requestKey,r.channel.key,t),P({from:a.privateToPublic(n),nonce:i.nonce.toString(),ciphertext:i.message,checksum:i.checksum},"sealed_message");var t,n,i},i.metadata=u({},n||{},{timeout:i.timeout,name:i.channel.name}),i.serialize=function(){return{type:"channel",data:r,metadata:i.metadata}},i}f(t,e);var r=t.prototype;return r.onSuccess=function(e,t){this.link.transport.onSuccess&&this.link.transport.onSuccess(e,t)},r.onFailure=function(e,t){this.link.transport.onFailure&&this.link.transport.onFailure(e,t)},r.onRequest=function(e,t){var r={expiration:new Date(Date.now()+this.timeout).toISOString().slice(0,-1)};this.link.transport.onSessionRequest&&this.link.transport.onSessionRequest(this,e,t),setTimeout((function(){t(new k("Wallet did not respond in time","E_TIMEOUT"))}),this.timeout+500),e.data.info.push({key:"link",value:P(r,"link_info")}),fetch(this.channel.url,{method:"POST",headers:{"X-Buoy-Wait":(this.timeout/1e3).toFixed(0),"Content-Type":"text/html",Accept:"text/html"},body:this.encrypt(e)}).then((function(e){200!==e.status&&t(new k("Unable to push message","E_DELIVERY"))})).catch((function(e){t(new k("Unable to reach link service ("+(e.message||String(e))+")","E_DELIVERY"))}))},r.prepare=function(e){return this.link.transport.prepare?this.link.transport.prepare(e,this):Promise.resolve(e)},r.showLoading=function(){if(this.link.transport.showLoading)return this.link.transport.showLoading()},r.makeSignatureProvider=function(){return this.link.makeSignatureProvider([this.publicKey],this)},r.makeAuthorityProvider=function(){return this.link.makeAuthorityProvider()},r.transact=function(e,t){return this.link.transact(e,t,this)},t}(L),j=function(e){function t(t,r,n){var i;return(i=e.call(this)||this).type="fallback",i.link=t,i.auth=r.auth,i.publicKey=r.publicKey,i.metadata=n||{},i.identifier=r.identifier,i.serialize=function(){return{type:i.type,data:r,metadata:i.metadata}},i}f(t,e);var r=t.prototype;return r.onSuccess=function(e,t){this.link.transport.onSuccess&&this.link.transport.onSuccess(e,t)},r.onFailure=function(e,t){this.link.transport.onFailure&&this.link.transport.onFailure(e,t)},r.onRequest=function(e,t){this.link.transport.onSessionRequest?this.link.transport.onSessionRequest(this,e,t):this.link.transport.onRequest(e,t)},r.prepare=function(e){return this.link.transport.prepare?this.link.transport.prepare(e,this):Promise.resolve(e)},r.showLoading=function(){if(this.link.transport.showLoading)return this.link.transport.showLoading()},r.makeSignatureProvider=function(){return this.link.makeSignatureProvider([this.publicKey],this)},r.makeAuthorityProvider=function(){return this.link.makeAuthorityProvider()},r.transact=function(e,t){return this.link.transact(e,t,this)},t}(L),I=function(){function e(e){if(this.abiCache=new Map,this.pendingAbis=new Map,this.walletType="","object"!=typeof e)throw new TypeError("Missing options object");if(!e.transport)throw new TypeError("options.transport is required, see https://github.com/greymass/anchor-link#transports");this.rpc=void 0===e.rpc||"string"==typeof e.rpc?new r.JsonRpc(e.rpc||"https://proton.greymass.com"):e.rpc,this.chainId=e.chainId?"number"==typeof e.chainId?t.nameToId(e.chainId):e.chainId:"384da888112027f0321850a169f737c33e53b388aad48b5adace4bab97f437e0",this.serviceAddress=(e.service||"https://cb.anchor.link").trim().replace(/\/$/,""),this.transport=e.transport,null!==e.storage&&(this.storage=e.storage),this.requestOptions={abiProvider:this,zlib:i,scheme:e.scheme},e.walletType&&e.walletType.length>0&&(this.walletType=e.walletType||"")}var n=e.prototype;return n.getAbi=function(){var e=c(b.mark((function e(t){var r,n;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.abiCache.get(t)){e.next=9;break}return(n=this.pendingAbis.get(t))||(n=this.rpc.get_abi(t),this.pendingAbis.set(t,n)),e.next=6,n;case 6:r=e.sent.abi,this.pendingAbis.delete(t),r&&this.abiCache.set(t,r);case 9:return e.abrupt("return",r);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.createCallbackUrl=function(){return this.serviceAddress+"/"+o.v4()},n.createRequest=function(){var e=c(b.mark((function e(r,n){var i,o;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n||this.transport,e.next=3,t.SigningRequest.create(u({},r,{chainId:this.chainId,broadcast:!1,callback:{url:this.createCallbackUrl(),background:!0}}),this.requestOptions);case 3:if(o=e.sent,!i.prepare){e.next=8;break}return e.next=7,i.prepare(o);case 7:o=e.sent;case 8:return e.abrupt("return",o);case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),n.sendRequest=function(){var e=c(b.mark((function e(r,n,i){var o,a,s,c,u,f,h,l,p,d,y;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===i&&(i=!1),o=n||this.transport,e.prev=2,(a=r.data.callback).startsWith(this.serviceAddress)){e.next=6;break}throw new Error("Request must have a link callback");case 6:if(2===r.data.flags){e.next=8;break}throw new Error("Invalid request flags");case 8:return c=N(a,s={}).then((function(e){if("string"==typeof e.rejected)throw new w("Rejected by wallet: "+e.rejected);return e})),u=new Promise((function(e,t){o.onRequest(r,(function(e){s.cancel&&s.cancel(),t("string"==typeof e?new w(e):e)}))})),e.next=13,Promise.race([c,u]);case 13:return h={actor:(f=e.sent).sa,permission:f.sp},l=Object.keys(f).filter((function(e){return e.startsWith("sig")&&"sig0"!==e})).map((function(e){return f[e]})),e.next=18,t.ResolvedSigningRequest.fromPayload(f,this.requestOptions);case 18:if((d=(p=e.sent).request.getInfo()).fuel_sig&&l.unshift(d.fuel_sig),y={request:p.request,serializedTransaction:p.serializedTransaction,transaction:p.transaction,signatures:l,payload:f,signer:h},!i){e.next=28;break}return e.next=26,this.rpc.push_transaction({signatures:y.signatures,serializedTransaction:y.serializedTransaction});case 26:y.processed=e.sent.processed;case 28:if(!y.request.isIdentity()){e.next=31;break}return e.next=31,this.checkIdentity(y);case 31:return o.onSuccess&&o.onSuccess(r,y),e.abrupt("return",y);case 35:throw e.prev=35,e.t0=e.catch(2),o.onFailure&&o.onFailure(r,e.t0),e.t0;case 39:case"end":return e.stop()}}),e,this,[[2,35]])})));return function(t,r,n){return e.apply(this,arguments)}}(),n.transact=function(){var e=c(b.mark((function e(t,r,n){var i,o,a,s;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=!r||!1!==r.broadcast,(i=n||this.transport)&&i.showLoading&&i.showLoading(),a=t,t.actions&&(a.expiration||a.ref_block_num||a.ref_block_prefix||a.max_net_usage_words||a.max_cpu_usage_ms||a.delay_sec)&&(t={transaction:u({expiration:"1970-01-01T00:00:00",ref_block_num:0,ref_block_prefix:0,max_net_usage_words:0,max_cpu_usage_ms:0,delay_sec:0},a)}),e.next=7,this.createRequest(t,i);case 7:return s=e.sent,e.next=10,this.sendRequest(s,i,o);case 10:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),n.identify=function(){var e=c(b.mark((function e(n,i){var o,a,s,c,f,h;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.createRequest({identity:{permission:n||null},info:i});case 2:return o=e.sent,e.next=5,this.sendRequest(o);case 5:if((a=e.sent).request.isIdentity()){e.next=8;break}throw new x("Unexpected response");case 8:return s=Buffer.concat([Buffer.from(o.getChainId(),"hex"),Buffer.from(a.serializedTransaction),Buffer.alloc(32)]),c=a.signer,f=r.Key.Signature.fromString(a.signatures[0]).recover(s).toLegacyString(),e.next=13,this.rpc.get_account(c.actor);case 13:if(h=e.sent,!n){e.next=17;break}if(!(n.actor!==t.PlaceholderName&&n.actor!==c.actor||n.permission!==t.PlaceholderPermission&&n.permission!==c.permission)){e.next=17;break}throw new x("Unexpected identity proof from "+R(c)+", expected "+R(n)+" ");case 17:return e.abrupt("return",u({},a,{account:h,signerKey:f}));case 18:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),n.checkIdentity=function(){var e=c(b.mark((function e(t){var n,i,o,a,s,c,u;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Buffer.concat([Buffer.from(t.request.getChainId(),"hex"),Buffer.from(t.serializedTransaction),Buffer.alloc(32)]),i=t.signer,o=r.Key.Signature.fromString(t.signatures[0]).recover(n).toLegacyString(),e.next=6,this.rpc.get_account(i.actor);case 6:if(a=e.sent){e.next=9;break}throw new x("Signature from unknown account: "+i.actor);case 9:if(s=a.permissions.find((function(e){return e.perm_name===i.permission}))){e.next=12;break}throw new x(i.actor+" signed for unknown permission: "+i.permission);case 12:if(u=(c=s.required_auth).keys.find((function(e){var t;return t=o,E(e.key)===E(t)}))){e.next=16;break}throw new x(R(i)+" has no key matching id signature");case 16:if(!(c.threshold>u.weight)){e.next=18;break}throw new x(R(i)+" signature does not reach auth threshold");case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.login=function(){var e=c(b.mark((function e(t){var n,i,o,a,s,c,f;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,O();case 2:return i=r.Key.PrivateKey.fromString(n=e.sent).getPublicKey().toLegacyString(),o={session_name:t,request_key:i},e.next=7,this.identify(void 0,{link:P(o,"link_create")});case 7:if(s={sameDevice:void 0!==(a=e.sent).request.getRawInfo().return_path},c=a.payload.link_ch&&a.payload.link_key&&a.payload.link_name?new T(this,{identifier:t,auth:a.signer,publicKey:a.signerKey,channel:{url:a.payload.link_ch,key:a.payload.link_key,name:a.payload.link_name},requestKey:n},s):new j(this,{identifier:t,auth:a.signer,publicKey:a.signerKey},s),!this.storage){e.next=13;break}return e.next=13,this.storeSession(t,c);case 13:if(!c.auth.actor){e.next=22;break}return e.next=16,this.rpc.get_table_rows({scope:"eosio.proton",code:"eosio.proton",json:!0,table:"usersinfo",lower_bound:c.auth.actor,upper_bound:c.auth.actor});case 16:if(!((f=e.sent.rows)&&f.length>0)){e.next=22;break}return e.next=21,this.rpc.isLightKYCVerified(f);case 21:c.accountData=e.sent;case 22:return this.walletType.length>0&&this.storage.write("wallet-type",this.walletType),e.abrupt("return",u({},a,{session:c}));case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.restoreSession=function(){var e=c(b.mark((function e(t,r){var n,i,o,a,s,c;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storage){e.next=2;break}throw new Error("Unable to restore session: No storage adapter configured");case 2:if(!r){e.next=6;break}n=this.sessionKey(t,R(r)),e.next=12;break;case 6:return e.next=8,this.listSessions(t);case 8:if(i=e.sent[0]){e.next=11;break}return e.abrupt("return",null);case 11:n=this.sessionKey(t,R(i));case 12:return e.next=14,this.storage.read(n);case 14:if(o=e.sent){e.next=17;break}return e.abrupt("return",null);case 17:e.prev=17,a=JSON.parse(o),e.next=24;break;case 21:throw e.prev=21,e.t0=e.catch(17),new Error("Unable to restore session: Stored JSON invalid ("+(e.t0.message||String(e.t0))+")");case 24:if(s=L.restore(this,a),!r){e.next=28;break}return e.next=28,this.touchSession(t,r);case 28:if(!s.auth.actor){e.next=37;break}return e.next=31,this.rpc.get_table_rows({scope:"eosio.proton",code:"eosio.proton",json:!0,table:"usersinfo",lower_bound:s.auth.actor,upper_bound:s.auth.actor});case 31:if(!((c=e.sent.rows)&&c.length>0)){e.next=37;break}return e.next=36,this.rpc.isLightKYCVerified(c);case 36:s.accountData=e.sent;case 37:return e.abrupt("return",s);case 38:case"end":return e.stop()}}),e,this,[[17,21]])})));return function(t,r){return e.apply(this,arguments)}}(),n.listSessions=function(){var e=c(b.mark((function e(t){var r,n;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storage){e.next=2;break}throw new Error("Unable to list sessions: No storage adapter configured");case 2:return r=this.sessionKey(t,"list"),e.prev=3,e.t0=JSON,e.next=7,this.storage.read(r);case 7:if(e.t1=e.sent,e.t1){e.next=10;break}e.t1="[]";case 10:e.t2=e.t1,n=e.t0.parse.call(e.t0,e.t2),e.next=17;break;case 14:throw e.prev=14,e.t3=e.catch(3),new Error("Unable to list sessions: Stored JSON invalid ("+(e.t3.message||String(e.t3))+")");case 17:return e.abrupt("return",n);case 18:case"end":return e.stop()}}),e,this,[[3,14]])})));return function(t){return e.apply(this,arguments)}}(),n.removeSession=function(){var e=c(b.mark((function e(t,r){var n;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storage){e.next=2;break}throw new Error("Unable to remove session: No storage adapter configured");case 2:return n=this.sessionKey(t,R(r)),e.next=5,this.storage.remove(n);case 5:return e.next=7,this.touchSession(t,r,!0);case 7:return e.next=9,this.storage.read("wallet-type");case 9:if(!e.sent){e.next=11;break}this.storage.remove("wallet-type");case 11:return e.next=13,this.storage.read("user-auth");case 13:if(!e.sent){e.next=15;break}this.storage.remove("user-auth");case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),n.clearSessions=function(){var e=c(b.mark((function e(t){var r,n,i;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storage){e.next=2;break}throw new Error("Unable to clear sessions: No storage adapter configured");case 2:return e.t0=m,e.next=5,this.listSessions(t);case 5:e.t1=e.sent,r=(0,e.t0)(e.t1);case 7:if((n=r()).done){e.next=13;break}return i=n.value,e.next=11,this.removeSession(t,i);case 11:e.next=7;break;case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.makeSignatureProvider=function(e,r){var n,i,o=this;return{getAvailableKeys:(i=c(b.mark((function t(){return b.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e);case 1:case"end":return t.stop()}}),t)}))),function(){return i.apply(this,arguments)}),sign:(n=c(b.mark((function e(n){var i,a,s;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r||o.transport,(a=t.SigningRequest.fromTransaction(n.chainId,n.serializedTransaction,o.requestOptions)).setCallback(o.createCallbackUrl(),!0),a.setBroadcast(!1),!i.prepare){e.next=8;break}return e.next=7,i.prepare(a);case 7:a=e.sent;case 8:return e.next=10,o.sendRequest(a,i);case 10:return e.abrupt("return",u({},n,{serializedTransaction:(s=e.sent).serializedTransaction,signatures:s.signatures}));case 14:case"end":return e.stop()}}),e)}))),function(e){return n.apply(this,arguments)})}},n.makeAuthorityProvider=function(){var e=this.rpc;return{getRequiredKeys:function(t){return c(b.mark((function r(){var n,i;return b.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.availableKeys,i=t.transaction,r.next=3,e.post("/v1/chain/get_required_keys",{transaction:i,available_keys:n.map(E)});case 3:return r.abrupt("return",r.sent.required_keys.map(E));case 5:case"end":return r.stop()}}),r)})))()}}},n.touchSession=function(){var e=c(b.mark((function e(t,r,n){var i,o,a,s;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n=!1),e.next=3,this.listSessions(t);case 3:if(i=e.sent,o=R(r),(a=i.findIndex((function(e){return R(e)===o})))>=0&&i.splice(a,1),s=this.sessionKey(t,"list"),!0!==n){e.next=13;break}return e.next=11,this.storage.remove(s);case 11:e.next=16;break;case 13:return i.unshift(r),e.next=16,this.storage.write(s,JSON.stringify(i));case 16:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),n.storeSession=function(){var e=c(b.mark((function e(t,r){var n,i;return b.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.sessionKey(t,R(r.auth)),i=JSON.stringify(r.serialize()),e.next=4,this.storage.write(n,i);case 4:return e.next=6,this.touchSession(t,r.auth);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),n.sessionKey=function(e,t){return[this.chainId,e,t].join("-")},e}();function N(e,t){return new Promise((function(r,i){var o=!0,a=0,s=e.replace(/^http/,"ws"),c=function(e){try{r(JSON.parse(e))}catch(e){e.message="Unable to parse callback JSON: "+e.message,i(e)}};!function e(){var r=new n(s);t.cancel=function(){o=!1,r.readyState!==n.OPEN&&r.readyState!==n.CONNECTING||r.close()},r.onmessage=function(e){if(o=!1,r.readyState===n.OPEN&&r.close(),"undefined"!=typeof Blob&&e.data instanceof Blob){var t=new FileReader;t.onload=function(){c(t.result)},t.onerror=function(e){i(e)},t.readAsText(e.data)}else"string"==typeof e.data?c(e.data):e.data instanceof ArrayBuffer?c(Buffer.from(e.data).toString()):c(e.data.toString())},r.onopen=function(){a=0},r.onerror=function(e){},r.onclose=function(t){var r;o&&setTimeout(e,(r=a++,Math.min(Math.pow(10*r,2),1e4)))}}()}))}function R(e){var r=e.actor,n=e.permission;return r===t.PlaceholderName&&(r="<any>"),n!==t.PlaceholderName&&n!==t.PlaceholderPermission||(n="<any>"),r+"@"+n}Object.defineProperty(exports,"PlaceholderAuth",{enumerable:!0,get:function(){return t.PlaceholderAuth}}),Object.defineProperty(exports,"PlaceholderName",{enumerable:!0,get:function(){return t.PlaceholderName}}),Object.defineProperty(exports,"PlaceholderPermission",{enumerable:!0,get:function(){return t.PlaceholderPermission}}),exports.CancelError=w,exports.IdentityError=x,exports.Link=I,exports.LinkChannelSession=T,exports.LinkFallbackSession=j,exports.LinkSession=L,exports.SessionError=k,exports.default=I;
//# sourceMappingURL=link.cjs.production.min.js.map
